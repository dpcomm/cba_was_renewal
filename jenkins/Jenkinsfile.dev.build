pipeline {
  agent { label 'joey-host' }
  options { disableConcurrentBuilds() }

  environment {
    REGISTRY = "ap-chuncheon-1.ocir.io"
    NAMESPACE = "axdhp42jvukm"
    IMAGE_RENEW = "${REGISTRY}/${NAMESPACE}/cba_was_renew:latest_dev"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Copy env file') {
      steps {
        withCredentials([
          file(credentialsId: 'env-dev', variable: 'ENV_DEV'),
          file(credentialsId: 'service-account-key', variable: 'SERVICE_ACCOUNT_KEY')
        ]) {
          sh '''
            set -e
            rm -f .env.dev serviceAccountKey.json
            cp "$ENV_DEV" .env.dev
            cp "$SERVICE_ACCOUNT_KEY" serviceAccountKey.json
          '''
        }
      }
    }

    stage('Login OCI') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'oci-registry-joey-local', usernameVariable: 'OCI_USER', passwordVariable: 'OCI_PASS')]) {
          sh '''
            set -e
            echo "$OCI_PASS" | docker login ${REGISTRY} -u "$OCI_USER" --password-stdin
          '''
        }
      }
    }

    stage('Build') {
      steps {
        sh '''
          set -e
          docker build -t ${IMAGE_RENEW} .
        '''
      }
    }

    stage('Push') {
      steps {
        sh '''
          set -e
          docker push ${IMAGE_RENEW}
        '''
      }
    }

    stage('Deploy') {
      steps {
        build job: 'cba-deploy-was_all-dev', wait: false
      }
    }
  }
}
